#!/bin/bash
# anchor-update-identity: Update identity context with automatic versioned backup
# Part of the Odyssean Anchor System v3.0

set -euo pipefail

# Get project root and anchor directories
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
ANCHOR_DIR="$PROJECT_ROOT/.anchor"
CURRENT_DIR="$ANCHOR_DIR/accessible/current"
HISTORY_DIR="$ANCHOR_DIR/protected/history"

# File paths
IDENTITY_FILE="$CURRENT_DIR/identity_context.oct.md"
TEMP_FILE="$CURRENT_DIR/.identity_context.oct.md.tmp"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to display usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Update identity context with automatic versioned backup"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help message"
    echo "  --backup-only  Only create backup, don't update file"
    echo "  --list         List all identity context versions"
    echo ""
    echo "Examples:"
    echo "  $0                    # Normal update workflow"
    echo "  $0 --backup-only      # Just create backup"
    echo "  $0 --list             # Show version history"
}

# Function to find next version number
get_next_version() {
    local count=$(ls "$HISTORY_DIR"/v*-identity.oct.md 2>/dev/null | wc -l)
    printf "v%03d" $((count + 1))
}

# Function to list versions
list_versions() {
    echo -e "${GREEN}Identity Context Version History:${NC}"
    echo "================================="
    
    if [ ! -d "$HISTORY_DIR" ] || [ -z "$(ls -A "$HISTORY_DIR"/v*-identity.oct.md 2>/dev/null)" ]; then
        echo -e "${YELLOW}No archived versions found${NC}"
        return 0
    fi
    
    for file in "$HISTORY_DIR"/v*-identity.oct.md; do
        if [ -f "$file" ]; then
            local version=$(basename "$file" | sed 's/-identity.oct.md//')
            local size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            local date=$(stat -f%Sm "$file" 2>/dev/null || stat -c%y "$file" 2>/dev/null)
            echo -e "${GREEN}$version${NC} - ${size} bytes - $date"
        fi
    done
}

# Function to create backup
create_backup() {
    local next_version=$(get_next_version)
    
    if [ ! -f "$IDENTITY_FILE" ]; then
        echo -e "${YELLOW}Warning: No current identity context file found at $IDENTITY_FILE${NC}"
        return 1
    fi
    
    # Create history directory if it doesn't exist
    mkdir -p "$HISTORY_DIR"
    
    # Create backup
    cp "$IDENTITY_FILE" "$HISTORY_DIR/$next_version-identity.oct.md"
    
    echo -e "${GREEN}‚úÖ Backup created: $next_version-identity.oct.md${NC}"
    echo "   Location: $HISTORY_DIR/$next_version-identity.oct.md"
    
    # Show backup info
    local size=$(stat -f%z "$HISTORY_DIR/$next_version-identity.oct.md" 2>/dev/null || stat -c%s "$HISTORY_DIR/$next_version-identity.oct.md" 2>/dev/null)
    echo "   Size: $size bytes"
    
    return 0
}

# Function to update identity context
update_identity() {
    echo -e "${GREEN}Identity Context Update Process${NC}"
    echo "=============================="
    echo ""
    echo "This script will:"
    echo "1. Create a versioned backup of current identity context"
    echo "2. Wait for you to update the identity context file"
    echo "3. Validate the new content"
    echo ""
    
    # Create backup first
    if ! create_backup; then
        echo -e "${RED}‚ùå Failed to create backup${NC}"
        return 1
    fi
    
    echo ""
    echo -e "${YELLOW}üîÑ Ready for identity context update${NC}"
    echo ""
    echo "The current identity context has been backed up."
    echo "You can now update the identity context file:"
    echo "  $IDENTITY_FILE"
    echo ""
    echo "When you're done updating, the new content will be automatically validated."
    echo ""
    echo "Press Enter when you've finished updating the identity context..."
    read -r
    
    # Validate new content
    if [ ! -f "$IDENTITY_FILE" ]; then
        echo -e "${RED}‚ùå Identity context file not found after update${NC}"
        return 1
    fi
    
    # Basic validation - check for key markers
    if ! grep -q "VALIDATION_KEY" "$IDENTITY_FILE"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: VALIDATION_KEY not found in identity context${NC}"
    fi
    
    if ! grep -q "ROLE::" "$IDENTITY_FILE"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: ROLE:: not found in identity context${NC}"
    fi
    
    echo -e "${GREEN}‚úÖ Identity context update completed${NC}"
    
    # Show summary
    local size=$(stat -f%z "$IDENTITY_FILE" 2>/dev/null || stat -c%s "$IDENTITY_FILE" 2>/dev/null)
    echo "   Updated file: $IDENTITY_FILE"
    echo "   Size: $size bytes"
    echo "   Backup: $(get_next_version | sed 's/v0*\([0-9]*\)/v\1/' | sed 's/v\([0-9]*\)/v\1 -> v\2/' | sed "s/v\([0-9]*\) -> v\([0-9]*\)/v$(($(get_next_version | sed 's/v0*\([0-9]*\)/\1/') - 1))/") in history"
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        usage
        exit 0
        ;;
    --backup-only)
        create_backup
        exit 0
        ;;
    --list)
        list_versions
        exit 0
        ;;
    "")
        update_identity
        exit 0
        ;;
    *)
        echo -e "${RED}‚ùå Unknown option: $1${NC}"
        usage
        exit 1
        ;;
esac