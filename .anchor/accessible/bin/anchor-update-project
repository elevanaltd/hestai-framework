#!/bin/bash
# anchor-update-project: Update project context with automatic versioned backup
# Part of the Odyssean Anchor System v3.0

set -euo pipefail

# Get project root and anchor directories
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
ANCHOR_DIR="$PROJECT_ROOT/.anchor"
CURRENT_DIR="$ANCHOR_DIR/accessible/current"
HISTORY_DIR="$ANCHOR_DIR/protected/history"

# File paths
PROJECT_FILE="$CURRENT_DIR/project_context.md"
TEMP_FILE="$CURRENT_DIR/.project_context.md.tmp"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to display usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Update project context with automatic versioned backup"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help message"
    echo "  --backup-only  Only create backup, don't update file"
    echo "  --list         List all project context versions"
    echo "  --session-id   Update session ID in project context"
    echo ""
    echo "Examples:"
    echo "  $0                    # Normal update workflow"
    echo "  $0 --backup-only      # Just create backup"
    echo "  $0 --list             # Show version history"
    echo "  $0 --session-id       # Update session ID to current timestamp"
}

# Function to find next version number
get_next_version() {
    local count=$(ls "$HISTORY_DIR"/v*-project.md 2>/dev/null | wc -l)
    printf "v%03d" $((count + 1))
}

# Function to list versions
list_versions() {
    echo -e "${GREEN}Project Context Version History:${NC}"
    echo "==============================="
    
    if [ ! -d "$HISTORY_DIR" ] || [ -z "$(ls -A "$HISTORY_DIR"/v*-project.md 2>/dev/null)" ]; then
        echo -e "${YELLOW}No archived versions found${NC}"
        return 0
    fi
    
    for file in "$HISTORY_DIR"/v*-project.md; do
        if [ -f "$file" ]; then
            local version=$(basename "$file" | sed 's/-project.md//')
            local size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            local date=$(stat -f%Sm "$file" 2>/dev/null || stat -c%y "$file" 2>/dev/null)
            
            # Try to extract session ID from file
            local session_id=$(grep "SESSION_ID:" "$file" 2>/dev/null | head -1 | sed 's/.*SESSION_ID: *"\([^"]*\)".*/\1/' || echo "N/A")
            
            echo -e "${GREEN}$version${NC} - ${size} bytes - $date - Session: $session_id"
        fi
    done
}

# Function to create backup
create_backup() {
    local next_version=$(get_next_version)
    
    if [ ! -f "$PROJECT_FILE" ]; then
        echo -e "${YELLOW}Warning: No current project context file found at $PROJECT_FILE${NC}"
        return 1
    fi
    
    # Create history directory if it doesn't exist
    mkdir -p "$HISTORY_DIR"
    
    # Create backup
    cp "$PROJECT_FILE" "$HISTORY_DIR/$next_version-project.md"
    
    echo -e "${GREEN}‚úÖ Backup created: $next_version-project.md${NC}"
    echo "   Location: $HISTORY_DIR/$next_version-project.md"
    
    # Show backup info
    local size=$(stat -f%z "$HISTORY_DIR/$next_version-project.md" 2>/dev/null || stat -c%s "$HISTORY_DIR/$next_version-project.md" 2>/dev/null)
    echo "   Size: $size bytes"
    
    # Extract and show session info
    local session_id=$(grep "SESSION_ID:" "$HISTORY_DIR/$next_version-project.md" 2>/dev/null | head -1 | sed 's/.*SESSION_ID: *"\([^"]*\)".*/\1/' || echo "N/A")
    local active_focus=$(grep "Active Focus" "$HISTORY_DIR/$next_version-project.md" 2>/dev/null | head -1 | sed 's/.*Active Focus.*: *\(.*\)/\1/' || echo "N/A")
    
    echo "   Session: $session_id"
    echo "   Focus: $active_focus"
    
    return 0
}

# Function to update session ID
update_session_id() {
    local new_session_id=$(date +%Y%m%d-%H%M%S)
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    if [ ! -f "$PROJECT_FILE" ]; then
        echo -e "${RED}‚ùå Project context file not found${NC}"
        return 1
    fi
    
    # Create backup first
    if ! create_backup; then
        echo -e "${RED}‚ùå Failed to create backup${NC}"
        return 1
    fi
    
    # Update session ID and timestamp
    sed -i.bak "s/SESSION_ID: \"[^\"]*\"/SESSION_ID: \"$new_session_id\"/" "$PROJECT_FILE"
    sed -i.bak "s/LAST_UPDATED: \"[^\"]*\"/LAST_UPDATED: \"$timestamp\"/" "$PROJECT_FILE"
    
    # Clean up sed backup file
    rm -f "$PROJECT_FILE.bak"
    
    echo -e "${GREEN}‚úÖ Session ID updated to: $new_session_id${NC}"
    echo "   Timestamp updated to: $timestamp"
    echo "   File: $PROJECT_FILE"
    
    return 0
}

# Function to update project context
update_project() {
    echo -e "${GREEN}Project Context Update Process${NC}"
    echo "============================="
    echo ""
    echo "This script will:"
    echo "1. Create a versioned backup of current project context"
    echo "2. Wait for you to update the project context file"
    echo "3. Validate the new content"
    echo ""
    
    # Create backup first
    if ! create_backup; then
        echo -e "${RED}‚ùå Failed to create backup${NC}"
        return 1
    fi
    
    echo ""
    echo -e "${YELLOW}üîÑ Ready for project context update${NC}"
    echo ""
    echo "The current project context has been backed up."
    echo "You can now update the project context file:"
    echo "  $PROJECT_FILE"
    echo ""
    echo "Common sections to update:"
    echo "  - CURRENT_WORK (Active Focus, Immediate Next, Context)"
    echo "  - PROGRESS_TRACKING (Completed, In Progress, Next Up)"
    echo "  - SESSION_NOTES (Current Session Goals, Issues Encountered)"
    echo "  - VALIDATION_SECTION (Integrity_Check, Last_Verified, Trust_Level)"
    echo ""
    echo "Press Enter when you've finished updating the project context..."
    read -r
    
    # Validate new content
    if [ ! -f "$PROJECT_FILE" ]; then
        echo -e "${RED}‚ùå Project context file not found after update${NC}"
        return 1
    fi
    
    # Basic validation - check for key sections
    local missing_sections=()
    
    if ! grep -q "## META" "$PROJECT_FILE"; then
        missing_sections+=("META")
    fi
    
    if ! grep -q "## BRIEF" "$PROJECT_FILE"; then
        missing_sections+=("BRIEF")
    fi
    
    if ! grep -q "## CURRENT_WORK" "$PROJECT_FILE"; then
        missing_sections+=("CURRENT_WORK")
    fi
    
    if ! grep -q "## ANCHOR_INTEGRATION" "$PROJECT_FILE"; then
        missing_sections+=("ANCHOR_INTEGRATION")
    fi
    
    if [ ${#missing_sections[@]} -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Missing sections: ${missing_sections[*]}${NC}"
    fi
    
    # Check for validation key
    if ! grep -q "ITHACA" "$PROJECT_FILE"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: ITHACA validation not found in project context${NC}"
    fi
    
    echo -e "${GREEN}‚úÖ Project context update completed${NC}"
    
    # Show summary
    local size=$(stat -f%z "$PROJECT_FILE" 2>/dev/null || stat -c%s "$PROJECT_FILE" 2>/dev/null)
    local session_id=$(grep "SESSION_ID:" "$PROJECT_FILE" 2>/dev/null | head -1 | sed 's/.*SESSION_ID: *"\([^"]*\)".*/\1/' || echo "N/A")
    local active_focus=$(grep "Active Focus" "$PROJECT_FILE" 2>/dev/null | head -1 | sed 's/.*Active Focus.*: *\(.*\)/\1/' || echo "N/A")
    
    echo "   Updated file: $PROJECT_FILE"
    echo "   Size: $size bytes"
    echo "   Session: $session_id"
    echo "   Focus: $active_focus"
    echo "   Backup: $(get_next_version | sed 's/v0*\([0-9]*\)/\1/' | awk '{print "v" ($1-1)}') in history"
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        usage
        exit 0
        ;;
    --backup-only)
        create_backup
        exit 0
        ;;
    --list)
        list_versions
        exit 0
        ;;
    --session-id)
        update_session_id
        exit 0
        ;;
    "")
        update_project
        exit 0
        ;;
    *)
        echo -e "${RED}‚ùå Unknown option: $1${NC}"
        usage
        exit 1
        ;;
esac